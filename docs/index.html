<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Coffee Sales (Spark + Charts)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #f8fafc; color: #0f172a; }
      .container { max-width: 1100px; margin: 0 auto; padding: 2rem 1rem 4rem; }
      h1 { margin-top: 0; }
      .note { color: #475569; margin-top: .25rem; font-size: .95rem; }
      .chart-grid { display: grid; gap: 1.75rem; margin-top: 1.5rem; }
      @media (min-width: 900px) {
        .chart-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .chart-grid .chart-card:nth-child(3) { grid-column: span 2; }
      }
      .chart-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08); }
      .chart-card h3 { margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; }
      .chart-card canvas { max-height: 420px; }
      .error { color: #b91c1c; background: #fee2e2; border: 1px solid #fecaca; padding: .75rem 1rem; border-radius: .5rem; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Coffee Sales (Spark → JSON → Charts)</h1>
      <p class="note">Data generated by <code>scripts/spark_etl.py</code> into <code>docs/assets/data.json</code>.</p>

      <div id="error" class="error" style="display:none"></div>

      <div class="chart-grid">
        <section class="chart-card">
          <h3>Monthly Total Sales</h3>
          <canvas id="totalSalesChart"></canvas>
        </section>
        <section class="chart-card">
          <h3>Sales Breakdown by Channel</h3>
          <canvas id="channelBreakdownChart"></canvas>
        </section>
        <section class="chart-card">
          <h3>Marketing Spend vs. Total Sales</h3>
          <canvas id="marketingScatterChart"></canvas>
        </section>
      </div>
    </div>

    <script>
      const usdFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
      const numberFormatter = value => usdFormatter.format(value);

      async function loadData() {
        const errEl = document.getElementById('error');
        try {
          const res = await fetch('assets/data.json', { cache: 'no-cache' });
          if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
          return await res.json();
        } catch (e) {
          errEl.style.display = '';
          errEl.textContent = `Failed to load data.json. Did you run scripts/spark_etl.py? (${e.message})`;
          throw e;
        }
      }

      function makeCharts(chartPayload) {
        new Chart(document.getElementById('totalSalesChart'), {
          type: 'line',
          data: {
            labels: chartPayload.months,
            datasets: [{
              label: 'Total sales',
              data: chartPayload.total_sales,
              fill: false,
              tension: 0.25,
              borderColor: 'rgb(16, 124, 165)',
              backgroundColor: 'rgba(16, 124, 165, 0.1)',
              pointRadius: 5,
              pointHoverRadius: 7,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { ticks: { callback: v => numberFormatter(v) } } },
            plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${numberFormatter(c.parsed.y)}` } }, legend: { display: false } }
          }
        });

        new Chart(document.getElementById('channelBreakdownChart'), {
          type: 'bar',
          data: {
            labels: chartPayload.months,
            datasets: [
              { label: 'In-store sales', data: chartPayload.in_store_sales, backgroundColor: 'rgba(234, 88, 12, 0.85)', stack: 'sales' },
              { label: 'Online sales', data: chartPayload.online_sales, backgroundColor: 'rgba(34, 197, 94, 0.85)', stack: 'sales' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { stacked: true, ticks: { callback: v => numberFormatter(v) } }, x: { stacked: true } },
            plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${numberFormatter(c.parsed.y)}` } } }
          }
        });

        new Chart(document.getElementById('marketingScatterChart'), {
          type: 'scatter',
          data: { datasets: [
            { label: 'Monthly totals', data: chartPayload.scatter_points, backgroundColor: 'rgba(59, 130, 246, 0.85)', pointRadius: 6 },
            { type: 'line', label: 'Regression line', data: chartPayload.regression_points, borderColor: 'rgba(239, 68, 68, 0.9)', borderWidth: 2, pointRadius: 0, fill: false, tension: 0 }
          ] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { title: { display: true, text: 'Marketing spend (USD)' }, ticks: { callback: v => numberFormatter(v) } },
              y: { title: { display: true, text: 'Total sales (USD)' }, ticks: { callback: v => numberFormatter(v) } }
            },
            plugins: { tooltip: { callbacks: { label: c => `${numberFormatter(c.parsed.x)} → ${numberFormatter(c.parsed.y)}` } } }
          }
        });
      }

      loadData().then(makeCharts).catch(() => {});
    </script>
  </body>
  </html>

